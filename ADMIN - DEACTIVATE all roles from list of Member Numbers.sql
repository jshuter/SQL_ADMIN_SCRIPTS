/* 

DEACTIVATE FROM A LIST OF Member Numbers 

This script is handy for deactivating a list that was extracted from a report or from another query 

If there are many 1,000s to delete, it is best to star twith a few small lists to insure that all is working properly

INSTRUCTIONS 

	1) update list of recnos 
	2) run with DEACTIVATE = NO 
	3) review results - insure data is as-expected 
	4) when ready - run with DEACTIVATE = 'YES'
	5) review and Commit OR Rollback 

*/

-- Make sure the one we want to deactivate meets the criteria

declare @toDeactivateCnt int = 0
declare @DEBUG tinyint = 0

declare @DEACTIVATE varchar(10) = 'NO' -- [ YES | NO ] 

--@Note: transaction need to be committed before emails will be sent

if(@DEACTIVATE = 'YES') begin 
	
	select 'STARTING WITH DEACTIVATION : ON'  
	begin transaction

end else begin 

	select 'STARTING WITH DEACTIVATION : OFF'  

end 

select * into #usersToDeactivate
from -- 82 unique numbers 
(
	select cst_key, cst_recno from co_customer
	where cst_recno in (
	
270802, 271093, 271484, 271736, 271770, 272317, 272354, 272389, 272560, 272640, 272790, 272830, 272933, 273207, 273255, 273622, 273776, 273788, 273890, 274219, 274364, 274388, 275361, 276068, 276482, 276848, 276856, 276970, 277333, 277490, 277585, 277964, 278162, 278343, 280947, 283282, 283947, 285298, 286293, 286919, 288972, 289102, 289380, 289645, 289706, 289944, 290295, 290621, 290798, 290819, 290846, 291039, 291080, 291097, 291243, 291377, 291396, 291402, 291563, 291629, 291741, 291847, 291866, 292447, 292454, 292592, 292618, 292633, 293170, 293209, 293373, 293423, 293621, 293813, 29382, 29386, 29406, 294154, 294498, 294648, 294955, 295036, 295060, 295420, 295719, 295804, 295967, 296040, 296074, 296125, 296298, 296748, 296856, 297118, 297833, 297852, 298219, 298487, 298506, 299380, 299593, 300136, 300752, 30085, 300903, 301298, 30154, 301540, 301916, 30226, 302338, 302459, 302619, 302678, 302773, 302798, 302869, 30306, 303218, 303256, 303297, 303334, 303709, 303745, 303804, 303896, 304128, 304403, 304409, 304413, 304766, 304848, 304904, 305427, 305582, 305614, 305692, 305780, 305867, 305872, 306307, 306385, 307528, 30792, 308366, 308429, 308710, 309440, 311957, 31347, 31425, 315089, 31654, 317034, 31817, 318558, 320184, 320337, 32201, 322293, 32266, 322721, 323598, 323850, 324941, 32520, 32537, 32697, 329999, 33070, 330736, 33086, 33100, 331783, 33188, 33274, 33281, 333319, 333388, 33429, 335580, 335806, 337412, 337600, 337848, 337984, 338126, 338236, 338436, 338616, 33883, 338950, 339041, 339124, 339394, 339904, 340056, 340243, 340247, 340277, 340364, 340396, 340452, 340453, 340532, 340607, 340658, 340728, 340886, 340970, 341347, 341539, 341729, 342119, 342250, 342272, 342317, 342465, 342738, 342835, 342898, 343019, 343093, 343166, 343597, 343756, 343991, 344280, 344360, 344566, 344607, 344826, 344876, 344940, 345040, 345078, 345427, 345555, 345583, 345636, 345654, 346590, 346666, 346775, 347033, 348106, 348664, 349797, 350007, 352238, 352254, 353016, 353898, 354121, 36421, 36465, 366506, 36837, 369486, 370004, 370035, 370557, 370861, 370998
,371020, 371049, 371093, 371482, 371557, 372060, 372119, 372245, 372530, 372697, 372900, 372905, 373002, 373310, 373366, 373849, 373859, 374025, 374067, 374132, 374183, 375006, 377089, 377124, 377208, 377397, 377452, 377520, 377764, 377836, 378095, 379369, 379451, 379503, 379693, 379818, 379943, 380022, 380105, 380510, 380538, 380651, 381325, 381648, 382197, 382450, 382457, 382703, 382763, 382803, 382922, 383098, 383330, 383486, 383666, 384279, 384585, 385036, 385173, 385177, 385240, 385525, 385660, 385734, 385800, 385801, 386229, 386487, 386580, 386609, 386626, 387059, 387147, 387269, 387628, 389433, 389454, 390129, 390317, 390381, 390415, 390585, 390763, 391037, 391086, 391211, 391230, 391238, 391401, 391453, 391714, 391900, 391931, 392138, 392429, 392635, 393910, 394398, 395798, 396637, 396977, 396985, 397114, 397414, 397427, 397440, 397694, 397739, 397998, 398026, 398120, 398194, 398240, 398357, 398810, 398889, 398930, 399004, 399067, 399246, 399555, 399571, 399580, 399638, 399680, 399766, 400130, 400170, 400204, 400284, 400402, 400409, 400560, 400663, 400939, 401135, 401534, 401965, 402184, 402311, 402331, 402339, 402590, 402750, 403052, 403098, 403437, 404650, 405022, 405294, 406088, 408581, 409364, 410141, 410446, 413790, 414653, 414900, 415057, 416275, 417606, 418031, 421215, 421889, 422488, 422503, 42276, 422957, 422973, 423116, 423125, 423229, 423330, 423600, 423605, 423915, 424045, 424188, 424221, 424454, 424606, 424642, 424928, 424945, 424986, 425193, 425305, 425314, 425353, 42541, 425460, 425684, 425705, 425947, 426054, 426154, 426335, 426380, 426814, 426855, 426919, 426992, 427223, 427253, 427360, 427452, 427479, 427493, 427708, 427783, 427891, 427910, 427933, 427935, 427966, 428195, 428445, 428591, 428601, 428932, 428988, 429149, 429160, 429216, 429376, 429672, 43079, 431121, 432611, 436128, 438760, 439567, 441189, 442511, 446375, 446494, 449373, 450341, 451032, 451549, 451753, 452452, 452473, 452571, 453052, 453294, 453731, 454314, 454403, 454412, 454652, 454762, 454805, 455155, 455383, 455397, 455731, 456186, 456994, 457860, 458815
,459440, 460253, 460407, 462937, 463893, 464325, 464418, 466577, 467866, 468026, 469444, 469784, 469851, 469942, 470417, 473487, 473578, 473716, 473815, 473979, 475049, 475449, 476516, 477478, 477785, 478198, 478926, 479789, 479891, 480816, 480979, 481948, 482023, 482817, 483442, 483810, 484232, 484994, 485372, 488688, 488762, 488965, 489402, 490015, 49086, 491113, 491128, 491669, 491845, 492027, 492468, 492827, 492958, 493209, 493899, 494192, 494798, 49480, 494851, 496445, 496897, 497220, 497391, 498520, 498669, 498924, 499150, 499186, 499432, 500119, 501198, 501510, 501650, 501784, 502121, 502441, 502480, 502510, 504346, 504934, 505254, 505683, 507110, 507152, 508294, 508515, 508583, 508621, 509942, 510708, 511190, 511316, 511463, 511685, 512901, 513130, 514091, 518114, 518167, 51846, 518745, 519170, 519261, 519805, 520657, 521919, 522156, 522341, 52267, 522949, 524221, 524770, 524948, 525503, 525645, 526212, 52642, 526579, 526887, 52696, 527134, 527262, 527413, 527729, 527781, 52837, 528463, 528961, 529301, 529489, 531021, 531073, 532758, 532965, 533532, 534317, 53502, 535330, 536057, 536616, 536772, 537781, 538458, 539059, 540362, 540486, 54078, 541405, 541479, 54157, 54205, 542058, 542271, 543168, 54318, 543455, 544472, 544693, 545081, 545168, 54627, 546369, 546849, 547154, 547575, 547664, 547804, 548253, 548500, 548536, 548576, 548738, 549124, 549407, 549741, 549851, 550910, 551942, 552178, 552195, 552536, 552716, 553420, 553884, 555524, 556037, 556059, 556254, 556745, 556990, 558879, 559070, 560337, 560433, 560540, 560607, 560683, 560737, 560889, 560899, 560965, 560988, 561198, 561682, 561962, 562646, 563636, 563726, 563828, 565038, 565624, 566049, 566122, 566130, 56615, 566713, 567276, 567916, 568165, 568188, 568531, 569346, 569613, 570370, 571419, 571914, 572393, 572690, 572805, 572951, 573361, 574148, 574242, 574839, 575257, 576232, 576444, 577164, 577497, 577699, 577822, 578295, 578304, 578333, 578934, 579009, 580519, 581338, 581721, 58191, 582134, 582255, 582393, 582580, 582759, 582991, 583124, 583240, 583982, 584166, 584267, 584390, 584407
,584441, 584997, 585234, 585349, 585463, 585471, 585473, 58581, 586411, 586429, 586495, 586539, 586890, 587005, 587191, 587336, 587544, 587776, 588712, 588715, 589016, 589341, 589347, 589591, 589946, 589958, 590010, 590589, 590770, 590805, 591315, 591810, 592149, 592438, 592539, 592988, 593164, 593616, 593708, 593849, 593888, 593892, 594042, 594256, 594578, 595086, 595236, 595310, 595786, 596319, 596726, 597345, 597802, 598259, 598279, 598387, 598437, 598569, 599346, 599719, 600021, 600217, 600782, 600830, 601839, 602925, 603186, 603390, 604060, 604168, 604306, 604467, 604551, 604590, 605022, 605730, 606086, 606332, 606772, 606922, 60718, 607804, 607814, 608409, 608881, 609536, 609956, 610017, 610260, 610532, 610847, 611214, 611402, 611586, 611663, 612008, 612133, 612906, 613911, 614162, 614234, 614479, 615012, 615229, 615305, 616162, 616306, 616484, 617103, 618512, 618923, 619044, 619378, 620106, 621344, 621406, 621451, 621862, 621915, 622032, 622754, 623075, 623303, 623442, 623506, 623543, 623941, 623942, 624272, 624489, 62472, 625230, 625454, 625771, 625794, 626061, 626181, 627899, 627978, 627980, 628229, 628289, 628757, 628854, 628907, 628932, 629090, 629324, 629805, 629922, 630540, 631140, 631213, 63122, 631279, 631381, 631414, 631618, 631785, 632425, 632605, 632994, 633433, 633451, 633812, 633943, 634281, 634304, 634621, 634709, 63471, 634988, 635353, 635578, 635760, 635897, 636289, 636462, 636659, 637047, 637048, 637161, 637406, 637478, 637886, 637888, 637899, 637991, 638035, 638486, 639097, 639470, 639628, 639924, 639968, 640107, 640327, 641026, 641448, 641617, 643302, 643409, 643654, 643684, 644987, 646096, 646285, 64662, 646742, 646932, 647228, 647285, 647298, 647505, 647594, 647753, 647928, 647953, 648039, 648336, 648472, 648807, 649014, 649128, 64945, 649712, 649756, 649934, 649975, 650201, 650222, 650415, 650947, 651631, 651780, 652018, 652055, 652508, 652913, 653238, 653384, 653616, 653706, 653810, 654342, 654454, 654614, 65463, 654937, 655298, 655582, 656161, 656213, 656422, 65659, 656973, 656993, 657937, 658056, 658522, 658832, 659673
,660396, 661448, 662366, 662390, 662578, 662746, 662854, 663531, 66404, 66409, 665038, 665110, 665256, 665349, 665758, 665799, 665852, 666321, 667036, 667235, 667282, 667614, 667878, 667914, 668127, 668261, 668283, 668317, 668587, 668619, 668780, 669174, 669205, 669302, 669494, 669699, 669746, 669790, 670037, 670074, 670399, 670718, 670929, 671248, 671258, 671946, 672359, 672613, 672837, 673339, 673584, 673771, 674233, 674389, 674417, 674475, 67488, 674889, 675213, 675499, 675627, 675893, 676067, 676195, 676965, 677150, 677167, 677352, 677593, 677616, 677831, 677858, 677885, 678096, 678351, 678546, 678587, 678660, 678677, 678782, 678830, 678952, 679139, 679169, 679526, 679580, 680253, 680510, 680677, 68104, 68119, 681217, 681310, 681369, 682000, 682669, 683279, 683380, 684161, 684582, 684885, 685048, 685419, 685483, 686242, 686838, 687250, 687427, 687632, 688080, 688214, 688379, 688583, 688846, 689616, 689712, 689818, 689965, 690550, 690982, 691207, 691244, 691791, 691912, 692117, 692618, 692870, 693142, 693187, 694138, 694423, 694425, 694817, 694905, 694942, 695124, 695366, 696007, 696513, 697133, 697809, 697855, 698180, 698389, 698543, 698807, 698823, 698858, 699428, 699489, 700374, 700713, 700736, 701779, 701782, 701884, 702028, 702175, 702670, 702834, 702842, 702949, 703009, 703225, 703370, 703636, 703855, 704554, 704615, 704807, 704880, 70508, 705098, 705299, 705595, 705972, 706115, 706209, 706278, 706375, 706399, 706559, 707395, 707866, 708890, 709112, 709261, 709630, 709711, 709998, 711662, 711739, 711803, 711924, 712186, 712248, 712293, 712510, 712534, 712653, 71312, 713197, 713531, 714011, 714126, 714229, 714232, 714892, 715184, 715576, 715601, 715604, 715648, 716990, 717106, 717409, 717441, 719637, 719903, 719985, 720560, 720834, 721078, 721518, 722168, 722489, 722916, 722981, 723235, 723426, 723681, 723912, 724254, 724274, 724960, 725456, 725484, 725637, 726309, 726342, 726358, 726667, 727235, 727864, 729016, 729107, 729309, 729452, 729853, 729909, 730766, 732148, 732279, 732406, 732858, 733025, 733140, 733720, 734393, 734812, 734992, 735054
,735445, 736052, 736737, 737529, 737781, 737930, 738343, 739046, 739995, 741222, 741811, 741889, 741891, 742669, 742721, 743499, 743775, 743782, 744395, 744869, 745093, 745325, 745625, 746103, 746121, 746746, 747039, 747461, 748339, 748375, 748759, 749211, 749864, 750321, 750714, 750723, 750846, 751025, 751257, 751329, 751358, 751439, 751556, 751681, 751719, 752602, 752661, 752691, 752714, 752908, 752977, 753202, 753241, 753531, 754021, 754353, 754594, 754804, 755090, 755184, 755203, 755253, 755410, 755930, 756435, 756480, 756492, 756493, 756817, 756859, 756944, 757501, 757622, 757922, 757973, 758180, 758203, 758556, 758698, 758714, 758947, 759041, 759171, 759417, 759546, 759553, 759679, 759773, 760194, 760369, 760483, 760502, 760537, 760589, 760741, 761214, 761732, 761743, 762095, 762171, 762324, 762491, 762612, 762665, 763048, 763087, 763219, 763228, 763434, 763513, 763645, 763656, 764083, 764770, 764888, 765044, 765188, 765574, 765873, 765969, 766349, 766594, 766988, 767391, 767538, 767949, 768173, 768222, 768255, 768262, 768372, 768445, 769089, 769272, 769380, 769762, 769800, 769916, 770096, 770430, 770627, 770811, 770907, 771472, 771519, 771698, 771709, 771762, 772404, 772945, 772975, 773635, 774496, 77503, 775136, 775180, 775275, 776568, 777226, 777366, 778160, 778281, 778528, 779678, 780034, 780057, 780202, 780247, 780254, 780524, 780996, 781351, 781515, 782210, 782317, 782512, 782602, 782933, 783154, 783482, 783609, 783710, 783751, 783792, 78421, 784212, 784318, 784360, 784897, 785102, 785259, 78542, 785522, 785572, 786454, 786532, 786658, 786885, 786932, 787033, 787094, 787143, 787320, 788199, 788408, 788888, 789635, 790348, 790680, 790701, 790782, 790930, 791044, 791217, 791291, 791794, 792305, 793126, 793399, 794491, 794563, 795397, 795567, 795814, 796015, 796492, 79675, 796775, 796817, 797083, 798074, 798188, 798525, 798649, 798743, 798937, 799138, 799212, 799464, 799535, 799610, 799900, 800510, 801234, 802479, 802580, 802652, 802954, 803016, 803284, 803353, 803399, 804078, 804177, 804292, 804353, 804481, 804757, 804838, 804946, 805446, 805642
,805707, 805800, 806222, 806963, 807224, 80769, 807810, 808226, 808546, 808678, 808854, 809016, 809052, 809322, 809542, 809740, 809912, 809988, 810067, 810142, 810222, 810274, 810443, 810451, 810507, 810733, 810876, 810990, 811029, 811099, 811135, 811614, 812415, 812791, 812903, 813518, 814001, 814388, 814826, 814953, 815524, 815546, 815946, 815953, 815977, 816013, 816473, 816528, 816534, 816629, 816767, 816855, 816894, 817021, 817486, 817866, 818060, 818279, 818526, 818622, 818647, 81879, 818841, 819303, 819433, 819496, 819755, 819764, 819962, 820040, 820215, 820274, 820465, 820620, 820785, 820795, 821054, 821117, 821665, 821959, 822004, 822192, 822327, 822935, 823038, 823074, 823099, 823221, 823298, 823363, 823754, 823932, 824938, 825116, 825449, 825522, 825700, 825866, 825908, 826066, 826159, 826242, 826304, 826629, 826667, 826745, 827588, 827744, 827782, 827879, 827884, 827942, 828399, 828434, 828678, 828715, 829084, 829263, 829588, 829750, 830624, 830832, 830880, 830944, 831533, 831807, 831837, 832861, 832966, 832975, 833059, 833132, 833244, 833267, 833466, 833674, 834349, 834449, 834567, 835103, 835923, 836177, 836272, 836296, 836307, 836373, 836428, 836536, 836651, 836944, 837009, 837015, 837067, 83726, 837273, 837314, 837329, 837533, 837767, 837913, 837935, 838088, 838112, 838333, 838381, 838656, 838868, 838921, 838959, 839120, 839183, 83943, 839443, 839545, 839774, 839864, 840050, 840096, 840508, 840515, 840804, 840923, 840968, 840996, 841018, 84103, 841030, 841159, 841359, 841394, 841645, 841807, 841841, 841894, 841909, 842189, 842433, 842443, 842454, 842466, 842499, 842791, 842822, 843044, 843170, 843211, 843235, 843316, 84333, 843442, 843488, 843680, 843756, 843787, 843810, 844245, 844424, 844478, 844576, 84462, 845150, 845444, 845530, 845648, 845686, 845694, 846005, 846646, 846720, 846836, 846869, 846901, 847030, 847313, 847487, 848102, 848174, 848309, 848602, 848664, 84883, 848979, 849142, 849169, 849456, 849712, 849860, 850014, 850058, 850347, 850579, 851055, 851152, 851190, 851412, 851865, 851957, 852221, 852560, 852632, 852657, 852718, 852894
,853151, 853169, 853231, 853376, 853741, 853900, 854079, 85423, 854374, 854601, 855006, 855101, 85538, 85567, 855694, 855743, 855779, 856652, 85679, 856960, 856991, 857121, 857320, 857411, 857456, 857502, 857636, 857897, 857977, 858155, 858157, 858305, 858311, 858437, 858520, 858632, 858797, 858901, 85905, 859208, 859281, 859723, 859855, 85993, 85994, 860042, 860172, 860222, 860269, 860303, 860666, 860863, 861563, 861608, 861632, 86182, 862087, 862338, 86263, 862694, 862719, 863162, 863216, 863332, 863450, 863516, 863573, 863734, 864375, 864748, 86484, 864881, 865235, 865565, 865939, 866114, 866198, 866407, 866408, 866485, 867187, 867305, 867513, 867668, 868012, 868078, 868287, 868387, 868573, 868939, 869685, 869695, 87081, 870992, 871015, 871102, 871313, 871537, 871704, 871872, 87197, 871972, 872378, 872477, 872831, 872897, 873339, 873822, 874220, 874383, 874387, 875073, 875200, 875344, 875973, 876141, 876339, 87649, 876690, 877164, 877252, 877295, 877582, 877646, 87801, 878067, 878254, 878518, 878653, 87902, 879212, 879777, 879866, 879914, 880386, 880443, 880541, 880679, 880908, 881126, 881174, 881302, 881553, 881645, 881727, 881808, 882153, 882210, 882348, 882395, 882423, 882570, 882973, 883115, 883145, 884551, 884703, 885335, 885574, 885665, 885667, 885779, 885827, 885894, 886232, 886638, 886687, 886808, 887101, 887402, 887646, 887864, 887898, 88792, 888452, 88855, 888721, 888843, 888963, 889091, 889220, 889225, 889499, 889693, 889758, 890175, 890264, 890502, 890548, 890866, 890907, 890968, 891000, 891002, 891061, 89144, 891697, 891863, 891986, 892003, 892055, 892467, 892788, 892883, 892931, 892990, 893093, 893207, 893532, 893855, 893994, 894398, 894505, 895136, 895517, 895614, 895680, 895702, 895857, 896089, 896112, 896312, 896366, 896411, 896618, 896622, 896703, 896918, 897022, 897304, 897338, 897611, 897659, 897703, 897767, 897808, 898043, 898101, 898808, 899191, 899287, 899418, 899475, 899514, 899620, 899730, 899854, 899907, 900077, 900125, 90022, 900250, 900298, 900303, 900308, 900908, 900990, 901300, 901380, 901619, 901692, 901988, 902649, 902712
,902934, 903015, 903515, 903780, 903838, 903859, 904131, 90425, 904340, 904367, 904614, 904641, 904663, 904740, 905880, 906034, 906504, 906544, 906700, 906705, 906858, 907092, 907108, 907127, 907251, 907449, 907524, 907833, 907905, 90847, 908542, 908802, 908812, 908860, 908868, 908961, 908986, 909096, 909106, 909143, 909198, 909243, 909307, 909368, 909542, 909673, 910120, 910226, 910369, 910486, 910547, 910594, 910769, 910784, 910788, 910799, 910898, 911163, 911373, 911502, 911582, 911789, 911893, 912010, 912047, 912367, 912369, 912534, 912839, 913115, 913663, 913807, 913942, 914119, 914151, 915515, 917463, 918657, 920664, 920851, 92397, 925915, 927154, 93115, 931975, 93254, 934577, 935426, 93641, 93853, 938569, 939024, 944054, 94579, 94716, 952482, 95613, 959113, 96462, 96471, 96493, 967086, 97085, 971811, 97257, 972842, 97420, 97529, 97885, 979117, 97926, 98018, 98072, 98571, 98689, 98834, 99006, 991393, 99464, 99704	
	) 
	
) ud

select 'unique cst_keys found :', count(*) as userCount from #usersToDeactivate


-- Part 1
select * into #ixoToDeactivate 
from
(
	select co_customer.cst_key as custkey, co_customer.cst_recno, co_customer.cst_eml_address_dn
			, co_customer.cst_name_cp, ixo_key, ixo_rlt_code, ixo_start_date, ixo_end_date, ixo_status_ext
			, ind_status_ext, C_ORG.cst_parent_cst_key,
			(select count(*) 
				from co_individual_x_organization IXOS
					join co_individual_x_organization_ext on ixo_key = ixo_key_ext
				where IXOS.ixo_ind_cst_key = co_customer.cst_key AND ixo_status_ext = 'Active') as active_count -- all the individual active roles
	from co_customer
		join co_individual on ind_cst_key = cst_key
		join co_individual_ext on ind_cst_key_ext = cst_key
		join co_individual_x_organization on ixo_ind_cst_key = cst_key
		join co_individual_x_organization_ext on ixo_key_ext = ixo_key
		join co_organization on org_cst_key = ixo_org_cst_key
		join co_organization_ext on org_cst_key_ext = org_cst_key
		join co_customer as C_ORG on C_ORG.cst_key = org_cst_key
		join mb_member_type ON mbt_key = ixo_mbt_key_ext
	where 
	co_customer.cst_recno in (select cst_recno from #usersToDeactivate)  -- customer id that didn't sign the COC
	AND isnull(co_individual_ext.ind_suspended_flag_ext,0) = 0 
	AND co_individual_x_organization.ixo_delete_flag = '0'
	AND co_individual.ind_delete_flag = 0
	AND isnull(co_individual.ind_deceased_flag,0) = 0 
	AND co_individual_x_organization_ext.ixo_status_ext in ('Active', 'Pending') 

	-- PAUL confirmed that we want to deactivate all their roles!!
	--AND (mb_member_type.mbt_code = 'Volunteer' OR co_individual_x_organization.ixo_rlt_code = 'Rover Scout Participant')
	--AND (co_individual_x_organization.ixo_rlt_code <> 'Kim') AND (co_individual_x_organization.ixo_rlt_code <> 'Keeo')
	/*AND (co_organization_ext.org_hierarchy_hash_ext Not Like '-000010229O-000027472O%') */
) a


SELECT  'LISTING IXO''s to Deactivate List' 

select * from #ixoToDeactivate order by cst_recno desc


if(@DEACTIVATE = 'YES') begin 
	PRINT ''
	PRINT 'Deactivate IXOs'
	update co_individual_x_organization_ext set ixo_status_ext = 'Inactive' where ixo_key_ext in (select ixo_key from #ixoToDeactivate)
end  

-- Part 2: 
-- Run the whole query again
-- Deactivate their status (if there are not any active roles)
-- Get the parent org contact email

select * into #indToDeactivate
from
(
	select ROW_NUMBER() OVER (ORDER BY cst_recno) as [Index], * 
	from
	(
		select custkey, cst_recno, cst_name_cp, cst_eml_address_dn, ind_status_ext, P_ORG.org_name, org_primary_contact_name_ext, org_primary_contact_email_ext	
		from #ixoToDeactivate
		join co_organization as P_ORG on org_cst_key = cst_parent_cst_key
		join co_organization_ext on org_cst_key_ext = cst_parent_cst_key
		group by  custkey, cst_recno,  cst_name_cp, cst_eml_address_dn, ind_status_ext,  P_ORG.org_name, org_primary_contact_name_ext, org_primary_contact_email_ext
	) c	
) b

select 'Listing Individual to Deactivate...'
select  custkey, cst_recno,cst_name_cp, cst_eml_address_dn, ind_status_ext, org_name, org_primary_contact_email_ext 
from #indToDeactivate
order by cst_recno desc 


--select @toDeactivateCnt = count(*) from #indToDeactivate

if(@DEACTIVATE = 'YES') begin 
	PRINT ''
	PRINT 'Deactivate Individuals'
	update co_individual_ext set ind_status_ext = 'Inactive' where ind_cst_key_ext in (select cst_key from #usersToDeactivate)
end  




if(@DEACTIVATE = 'YES') begin 

	select 'POST UPDATE review ...'
	
	select co_individual_ext.ind_status_ext, custkey, cst_recno,cst_name_cp, cst_eml_address_dn, #indToDeactivate.ind_status_ext, org_name, org_primary_contact_email_ext 
	from #indToDeactivate
	join co_individual_ext on co_individual_ext.ind_cst_key_ext = #indToDeactivate.custkey  

	order by cst_recno desc 

	select co_individual_x_organization_ext.ixo_status_ext, #ixoToDeactivate.* from #ixoToDeactivate 
	join co_individual_x_organization_ext on ixo_key_ext = #ixoToDeactivate.ixo_key  
	order by cst_recno desc
	
end 

-- after real deactivation .. leave temp data around for review 
--if(@DEACTIVATE <> 'YES') begin 

	drop table #usersToDeactivate
	drop table #indToDeactivate
	drop table #ixoToDeactivate

--end 

--rollback
--commit










